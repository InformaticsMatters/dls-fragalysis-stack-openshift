#!groovyâ€‹

// The Fragalysis Graph Database Builder.

pipeline {

  agent { label 'buildah-slave' }

  environment {
    USER = 'jenkins'
    REGISTRY = 'docker-registry.default:5000'

    GRAPH_IMAGE = 'fragalysis-cicd/graph:latest'
    GRAPH_STREAM_IMAGE = "${REGISTRY}/fragalysis-cicd/graph-stream:latest"
  }

  stages {

    stage('Inspect') {
      steps {
        dir('images/graph') {
          script {
            DATA_ORIGIN = sh(script: './get_unbuilt_data_directory.py', returnStdout: true).trim()
          }
        }
      }
    }

    stage('Build') {
      when {
        expression { DATA_ORIGIN.length() > 0 }
      }
      steps {
        dir('images/graph') {
          echo "Building ${DATA_ORIGIN}..."
          sh "cp /source-data/${DATA_ORIGIN}/* data-loader"
          sh "buildah bud --format docker --build-arg DATA_ORIGIN=$DATA_ORIGIN -f Dockerfile -t ${env.GRAPH_STREAM_IMAGE}"
        }
      }
    }

    stage('Push') {
      steps {
        script {
          TOKEN = sh(script: 'oc whoami -t', returnStdout: true).trim()
        }
        sh "podman login --tls-verify=false --username ${env.USER} --password ${TOKEN} ${env.REGISTRY}"
        sh "buildah push --tls-verify=false ${env.GRAPH_STREAM_IMAGE} docker://${env.GRAPH_STREAM_IMAGE}"
        sh "podman logout ${env.REGISTRY}"
      }
    }

  }

}
