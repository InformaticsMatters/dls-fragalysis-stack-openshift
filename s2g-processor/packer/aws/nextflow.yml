---

# Packer machine image configuration for a Nextflow/Docker machine.
#
# To use this file (Packer expects a JSON file) you need to
# use the project's yaml2json module to convert it to JSON.
# From this directory and a Suitable Python (see root's requirements.txt)
# you can run...
#
#   ../../../yaml2json.py < nextflow.yml > nextflow.json
#
# Then, to create the AMI for later use, run Packer...
#
#   packer build nextflow.json
#
# Your AMI will be seen and available at the ends fo the Packer run.

variables:

  aws_access_key: "{{env `TF_VAR_aws_access_key`}}"
  aws_secret_key: "{{env `TF_VAR_aws_secret_key`}}"
  aws_user: centos
  aws_i_type: t2.micro
  our_name: Nextflow Base Image
  base_ami_name: im-nf-1
  base_description: |-
    CentOS Linux 7 x86_64 HVM EBS 1708_11.01 for Nextflow with Docker 1.12.6

builders:

# AWS Builder - Ireland

- access_key: "{{user `aws_access_key`}}"
  secret_key: "{{user `aws_secret_key`}}"
  type: amazon-ebs
  region: eu-west-1
  source_ami: ami-192a9460
  # xchem VPC identification and a
  # a valid subnet for it...
  vpc_id: vpc-fcf29e9a
  subnet_id: subnet-a1bc02e9
  security_group_id: sg-6fca2813
  # We're using a non-default VPC
  # so we have to assign a public IP to the instance...
  associate_public_ip_address: true
  instance_type: "{{user `aws_i_type`}}"
  ssh_username: "{{user `aws_user`}}"
  name: "{{user `our_name`}} Ireland"
  ami_name: "{{user `base_ami_name`}}"
  ami_description: "{{user `description`}}"

provisioners:

- type: shell
  inline:
  # Basic Centos, Docker and stuff....
  - sudo yum -y install wget git net-tools bind-utils iptables-services
  - sudo yum -y install bridge-utils bash-completion kexec-tools sos psacct
  - sudo curl -fsSL https://get.docker.com/ | sh
  - sudo systemctl enable docker
  - sudo systemctl start docker
  - sudo yum -y install NetworkManager
  - sudo systemctl enable NetworkManager
  - sudo systemctl start NetworkManager
  # Now Java and Nextflow...
  - sudo yum -y install java-1.8.0-openjdk-devel
  - sudo wget -qO- https://get.nextflow.io | bash

- type: file
  source: ../../graph.nf
  destination: /home/centos/graph.nf
