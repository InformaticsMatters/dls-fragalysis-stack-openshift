---

- name: Install head packages
  yum:
    name:
    - epel-release
    - nfs-utils
    - nfs-utils-lib

# Setup NFS share and head node mounts
# The

- name: Create slurm (home) mount-point
  file:
    path: "{{ slurm_home_path }}"
    state: directory
    mode: 0777
    owner: root
    group: root

- name: Unmount device
  mount:
    path: "{{ slurm_home_path }}"
    state: unmounted

- name: Ensure device has a filesystem
  filesystem:
    fstype: ext4
    dev: "{{ os_slurm_volume_device }}"

- name: Mount device
  mount:
    src: "{{ os_slurm_volume_device }}"
    path: "{{ slurm_home_path }}"
    fstype: ext4
    opts: defaults
    passno: 2
    state: mounted

- name: Create NFS exports
  copy:
    content: "{{ slurm_home_path }} *(rw,no_root_squash)"
    dest: /etc/exports
    owner: root
    group: root
  notify: Restart NFS

- name: Create MUNGE key
  set_fact:
    munge_key: "{{ lookup('password', '/dev/null length=1024') }}"

- import_tasks: configure-munge.yaml
- import_tasks: configure-slurm.yaml
